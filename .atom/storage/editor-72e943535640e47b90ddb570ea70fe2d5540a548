{"mode":"editor","version":1,"windowDimensions":{"x":896,"y":56,"width":1024,"height":1024},"syntax":{"deserializer":"Syntax","grammarOverridesByPath":{}},"project":{"path":"/Users/kwatanabe/git/whiteplus/hiroie/hiroie_api_develop/api.hiroie.jp/fuel/app/classes/controller/admin","buffers":[{"text":"<?php\n\n/**\n * Class Controller_Admin_Loader\n *\n * @package  app\n * @extends  Controller\n */\nclass Controller_Admin_Loader extends Controller_Base\n{\n    /**\n     * 画面表示情報設定\n     */\n    private function buildLayout()\n    {\n        $this->template->set_global('title', 'データローダー');\n        $this->template->set_global('message_info', '');\n        $this->template->set_global('message_error', '');\n        $this->template->header  = View::forge('layout/header');\n        $this->template->content = View::forge('admin/loader');\n        $this->template->footer  = View::forge('layout/footer');\n    }\n\n    public function get_index()\n    {\n        $this->buildLayout();\n    }\n\n    public function post_index()\n    {\n\n        $this->buildLayout();\n\n        //ロードしたいテーブル名を記述\n        $mode = Input::post()['mode'][0];\n        if ($mode === 'load') {\n            $tables = array(\n                //'t_user',\n                'm_code',\n                'm_version',\n                'm_category',\n                'm_tax',\n                'm_campaign',\n                'm_warehouse',\n                't_systemuser',\n                'm_space',\n                'm_zipcode',\n                'm_spacecharge',\n                'm_baggagetype',\n                'm_transportcharge',\n                'm_apikey'\n            );\n        } else {\n            //削除順番重要(子から削除)\n            $tables = array(\n                'm_apikey',\n                'm_version',\n                't_salesdetailsbaggage',\n                't_sales',\n                't_coupondiscount',\n                't_campaignlog',\n                'm_campaign',\n                't_promotionhistory',\n                't_promotion',\n                't_requestbaggage',\n                't_requestlog',\n                't_request',\n                't_baggagelog',\n                't_baggage',\n                't_contractlog',\n                't_contract',\n                't_message',\n                't_user',\n                'm_code',\n                'm_tax',\n                'm_zipcode',\n                'm_warehouse',\n                't_systemuser',\n                'm_spacecharge',\n                'm_transportcharge',\n                'm_space',\n                'm_baggagetype',\n                'm_category',\n            );\n        }\n\n        //制限時間がdefaultの30秒だと住所マスタが登録出来ないため\n        set_time_limit(120);\n\n        $messages = array();\n        try {\n            DB::start_transaction();\n            // AUTOINCREMENT設定\n            if ($mode === 'load') {\n                $setting_file_path = APPPATH . '/../../data/table/autoincrement.txt';\n                Util_Loader::set_autoincrement($setting_file_path);\n            }\n\n            foreach ($tables as $table_name) {\n                $base_path = APPPATH . '/../../data/table/';\n                $file_path = $base_path . $table_name . '.txt';\n                if ($mode === 'load') {\n                    Util_Loader::load($table_name, $file_path);\n                    array_push($messages, $table_name . \":ロード完了\");\n                } else {\n                    Util_Loader::delete($table_name);\n                    array_push($messages, $table_name . \":削除完了\");\n                }\n            }\n\n        } catch (Exception $e) {\n            DB::rollback_transaction();\n            set_time_limit(30);\n            throw $e;\n        }\n\n        DB::commit_transaction();\n        set_time_limit(30);\n\n        $this->template->set_global('message_info', Debug::dump($messages) . PHP_EOL, '');\n    }\n}\n","markers":{"markers":{"1":{"id":1,"range":[[55,27],[55,27]],"tailed":false,"reversed":true,"valid":true,"invalidate":"never","persistent":true,"properties":{"type":"selection","editorId":9,"goalBufferRange":null,"preserveFolds":true},"deserializer":"Marker"}},"deserializer":"MarkerManager"},"history":{"undoStack":[{"patches":[{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"reversed":false,"range":[[46,18],[46,18]]},"newParams":{"reversed":true,"range":[[46,17],[46,18]]},"deserializer":"MarkerPatch"},{"oldRange":[[46,17],[46,18]],"newRange":[[46,17],[46,17]],"oldText":"/","newText":"","normalizeLineEndings":true,"markerPatches":{},"deserializer":"BufferPatch"},{"id":1,"oldParams":{"tailed":true},"newParams":{"tailed":false},"deserializer":"MarkerPatch"}],"deserializer":"Transaction"},{"patches":[{"id":1,"oldParams":{"tailed":false},"newParams":{"tailed":true},"deserializer":"MarkerPatch"},{"id":1,"oldParams":{"range":[[46,17],[46,17]]},"newParams":{"range":[[46,16],[46,17]]},"deserializer":"MarkerPatch"},{"oldRange":[[46,16],[46,17]],"newRange":[[46,16],[46,16]],"oldText":"/","newText":"","normalizeLineEndings":true,"markerPatches":{},"deserializer":"BufferPatch"},{"id":1,"oldParams":{"tailed":true},"newParams":{"tailed":false},"deserializer":"MarkerPatch"}],"deserializer":"Transaction"}],"redoStack":[],"deserializer":"History"},"filePath":"/Users/kwatanabe/git/whiteplus/hiroie/hiroie_api_develop/api.hiroie.jp/fuel/app/classes/controller/admin/loader.php","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"05893d22479ab428f64a9de76d5b40763b9d5960","deserializer":"TextBuffer"}],"deserializer":"Project"},"workspace":{"paneContainer":{"root":{"items":[{"id":9,"softTabs":true,"displayBuffer":{"id":10,"softWrap":false,"editorWidthInChars":94,"scrollTop":241,"scrollLeft":0,"tokenizedBuffer":{"bufferPath":"/Users/kwatanabe/git/whiteplus/hiroie/hiroie_api_develop/api.hiroie.jp/fuel/app/classes/controller/admin/loader.php","tabLength":4,"deserializer":"TokenizedBuffer"},"deserializer":"DisplayBuffer"},"deserializer":"Editor"}],"activeItemUri":"/Users/kwatanabe/git/whiteplus/hiroie/hiroie_api_develop/api.hiroie.jp/fuel/app/classes/controller/admin/loader.php","focused":true,"active":true,"deserializer":"Pane"},"deserializer":"PaneContainer"},"fullScreen":false,"deserializer":"Workspace"},"packageStates":{"fuzzy-finder":{"/Users/kwatanabe/git/whiteplus/hiroie/hiroie_api_develop/api.hiroie.jp/fuel/app/classes/controller/admin/loader.php":1398820486997},"keybinding-resolver":{"attached":false},"metrics":{"sessionLength":1339146},"tree-view":{"directoryExpansionStates":{},"selectedPath":"/Users/kwatanabe/git/whiteplus/hiroie/hiroie_api_develop/api.hiroie.jp/fuel/app/classes/controller/admin/loader.php","hasFocus":false,"attached":true,"scrollLeft":0,"scrollTop":0,"width":200},"script":{"scriptOptionsViewState":""}}}